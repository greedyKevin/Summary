# 分布式锁

## 定义

在分布式系统下的锁

## 为什么需要

分布式系统共享操作一个资源

## 如何实现

### 单机redis

* 使用具有互斥性的命令 **SETNX**

#### 死锁

* 程序业务逻辑异常，没有释放锁
* 进程挂了没有机会释放锁

#### 如何避免死锁

* 给锁设置过期时间

##### 存在的问题

* **锁过期**：客户端操作时间过长，导致锁释放
  * 添加**守护进程**快要过期时候，续期**锁的时间**
* **释放别人的锁**：客户端1操作完后，释放了客户端2的锁
  * 释放锁时候先判断**锁是否属于自己**

### 主从集群redis

#### 场景问题

* 客户端在主库加锁成功
* 主库宕机，set命令未同步到从库
* 哨兵提升为新主库，锁丢失

#### RedLock

使用前提：

 	1. 只部署主库
 	2. 至少5个主库

##### 流程

 	1. 客户端获取时间戳**t1**
 	2. 客户端依次向5个redis实例发起加锁命令，且每个请求会设置超时时间（毫秒级，要远小于锁的有效时间），如果某一个实例加锁失败（包括网络超时、锁被其它人持有等各种异常情况），就立即向下一个 Redis 实例申请加锁

 	3. 如果客户端从 >=3 个（大多数）以上 Redis 实例加锁成功，则再次获取「当前时间戳**t2**」，如果 t2 - t1 < 锁的过期时间，此时，认为客户端加锁成功，否则认为加锁失败
 	4. 加锁成功，操作共享资源
 	5. 加锁失败，向全部节点**发起释放锁**的请求

---

## 参考资料

http://kaito-kidd.com/2021/06/08/is-redis-distributed-lock-really-safe/